// –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env —Ñ–∞–π–ª–∞
require('dotenv').config();
const express = require('express');
const TelegramBot = require('node-telegram-bot-api');
const axios = require('axios');

// ===== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø =====
// –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ: —Ç–æ–∫–µ–Ω –±–µ—Ä–µ—Ç—Å—è –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
const token = process.env.BOT_TOKEN;
const webhookUrl = process.env.WEBHOOK_URL;
const port = process.env.PORT || 3000;

// –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä Express.js –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
const app = express();
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–æ—Ç–∞ (–ø–æ–∫–∞ –±–µ–∑ –æ–ø—Ä–æ—Å–∞)
const bot = new TelegramBot(token);

// ===== MIDDLEWARE =====
// –≠—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —á—Ç–µ–Ω–∏—è JSON –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∑–∞–ø—Ä–æ—Å–æ–≤
app.use(express.json());

// ===== –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ù–ê–°–¢–†–û–ô–ö–ò –í–ï–ë–•–£–ö–ê =====
async function setupWebhook() {
  try {
    // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π URL –¥–ª—è –≤–µ–±—Ö—É–∫–∞
    const url = `${webhookUrl}/webhook`;
    console.log(`[Webhook] –ü—ã—Ç–∞—é—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–µ–±—Ö—É–∫ –Ω–∞ URL: ${url}`);

    // –°–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –≤–µ–±—Ö—É–∫, –µ—Å–ª–∏ –±—ã–ª
    await axios.get(`https://api.telegram.org/bot${token}/deleteWebhook`);

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π –≤–µ–±—Ö—É–∫
    // –ü–∞—Ä–∞–º–µ—Ç—Ä drop_pending_updates=true –æ—á–∏—â–∞–µ—Ç –æ—á–µ—Ä–µ–¥—å —Å–æ–æ–±—â–µ–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥–ª–∏ –Ω–∞–∫–æ–ø–∏—Ç—å—Å—è
    const setWebhookUrl = `https://api.telegram.org/bot${token}/setWebhook?url=${url}&drop_pending_updates=true`;
    const response = await axios.get(setWebhookUrl);

    console.log('[Webhook] –†–µ–∑—É–ª—å—Ç–∞—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏:', response.data);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤–µ–±—Ö—É–∫ —É—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
    const webhookInfo = await axios.get(`https://api.telegram.org/bot${token}/getWebhookInfo`);
    console.log('[Webhook] –¢–µ–∫—É—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:', webhookInfo.data);
  } catch (error) {
    console.error('[Webhook] –û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ:', error.message);
  }
}

// ===== –û–°–ù–û–í–ù–´–ï –ú–ê–†–®–†–£–¢–´ (ENDPOINTS) =====

// –ú–∞—Ä—à—Ä—É—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞
app.get('/', (req, res) => {
  res.json({ 
    status: 'OK', 
    message: 'Webhook server is running!',
    timestamp: new Date().toISOString()
  });
});

// –ì–ª–∞–≤–Ω—ã–π endpoint, –∫—É–¥–∞ Telegram –±—É–¥–µ—Ç –ø—Ä–∏—Å—ã–ª–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
app.post('/webhook', async (req, res) => {
  try {
    const update = req.body;
    // console.log('–ü–æ–ª—É—á–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:', update); // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏

    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    if (update.message && update.message.text) {
      const chatId = update.message.chat.id;
      const text = update.message.text;
      const userName = update.message.from.first_name || '–î—Ä—É–≥';

      // –ü—Ä–∏–≤–æ–¥–∏–º —Ç–µ–∫—Å—Ç –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏
      const lowerText = text.toLowerCase();

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /start
      if (lowerText === '/start' || lowerText.startsWith('/start@')) {
        await bot.sendMessage(
          chatId, 
          `–ó–¥–∞—Ä–æ–≤–∞ –µ–±–∞—Ç—å, ${userName}! üöÄ –Ø —Ç–≤–æ–π –±—Ä–∞—Ç–∏—à–∫–∞ –≤ —ç—Ç–æ–º —á–∞—Ç–µ!\n\n–ú–Ω–æ–≥–æ –ø–∏–∑–¥–µ—Ç—å –Ω–µ –±—É–¥—É, –Ω–æ –∏ –º–æ–ª—á–∞—Ç—å –Ω–µ —Å–æ–±–∏—Ä–∞—é—Å—å!` 
          // `–ú–æ–∂–µ—à—å –Ω–∞–∂–∞—Ç—å /fuck - –ø–æ—à–ª—é –∫–æ–≥–æ-–Ω–∏–±—É–¥—å –Ω–∞—Ö—É–π`
          // `–ñ–º–∏:\n` +
          // `/fuck - —Å–ª—É—á–∞–π–Ω–∞—è —à—É—Ç–∫–∞\n` +
          // `–ù–∞–ø–∏—à–∏ "—Å–∫—É—á–Ω–æ" - —è –ø—Ä–µ–¥–ª–æ–∂—É —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏–µ\n` +
          // `–ù–∞–ø–∏—à–∏ "–∫–æ—Ñ–µ" - —è –ø–æ–¥–¥–µ—Ä–∂—É –∫–æ—Ñ–µ–ø–∞—É–∑—É`
        );
      } 

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /fuck
      else if (lowerText === '/fuck' || lowerText.startsWith('/fuck@')) {
        const jokes = [
          "–ü–æ—á–µ–º—É –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç—ã —Ç–∞–∫ –ø–ª–æ—Ö–æ —Ç–∞–Ω—Ü—É—é—Ç? –£ –Ω–∏—Ö –Ω–µ—Ç –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤!",
          "–ß—Ç–æ —Å–∫–∞–∑–∞–ª –æ–¥–∏–Ω HTTP-–∑–∞–ø—Ä–æ—Å –¥—Ä—É–≥–æ–º—É? –¢—ã —Ç–æ–ª—å–∫–æ –Ω–µ –æ–ø—è—Ç—å...",
          "–ö–∞–∫–æ–π —Å–∞–º—ã–π –∞–ª–∫–æ–≥–æ–ª—å–Ω—ã–π —è–∑—ã–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è? Java-Script!",
          "–ü–æ—á–µ–º—É Python –Ω–µ –ø–æ—à–µ–ª –Ω–∞ –≤–µ—á–µ—Ä–∏–Ω–∫—É? –ü–æ—Ç–æ–º—É —á—Ç–æ —É –Ω–µ–≥–æ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π!",
          "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞—é—Ç –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –±–æ–∏—Ç—Å—è –∂–µ–Ω—â–∏–Ω? –ì–∏—Ç—Ö–∞–±–æ—Ñ–æ–±."
        ];

        const randomJoke = jokes[Math.floor(Math.random() * jokes.length)];
        await bot.sendMessage(chatId, randomJoke);
      }

      // –†–µ–∞–∫—Ü–∏—è –Ω–∞ —Å–ª–æ–≤–æ "–ø–∏–≤–æ"
      else if (lowerText.includes('–ø–∏–≤') || lowerText.includes('–ø–∏–≤–æ') || lowerText.includes('–ø–∏–≤–Ω')) {
        const phrasesAboutBeer = [
          '—è —Ç–æ–ª—å–∫–æ –ø–æ–¥—É–º–∞–ª –æ –ø–∏–≤–µ –∏ —Ç—É—Ç –Ω–∞ –Ω–∞—Ö—É–π!',
          '–ø–µ–π –ø–∏–≤–æ –ø–µ–Ω–Ω–æ–µ ‚Äî –±—É–¥–µ—Ç –∂–∏–∑–Ω—å –æ—Ç–º–µ–Ω–Ω–∞—è!',
          '–∫–∞–∫ –≥–æ–≤–æ—Ä–∏—Ç –ñ–µ–∫–∞ –ì–æ—Ä–ª–æ–≤–æ–π - –°–∞–Ω—è –Ω–∞—Å–æ—Å –ø–∏–≤–Ω–æ–π)',
          '–ª—É—á—à–µ –ø–∏–≤–æ –≤ —Ä—É–∫–µ, —á–µ–º –¥–µ–≤–∏—Ü–∞ –≤–¥–∞–ª–µ–∫–µ',
          '—É —á–µ–ª–æ–≤–µ–∫–∞ –≤—Å–µ–≥–¥–∞ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≥–æ—Ä—è—á–µ–µ —Å–µ—Ä–¥—Ü–µ –∏ —Ö–æ–ª–æ–¥–Ω–æ–µ –ø–∏–≤–æ!',
        ];

        const randomPhrase = phrasesAboutBeer[Math.floor(Math.random() * phrasesAboutBeer.length)];
        await bot.sendMessage(chatId, `${userName}, –¥–∞–≤–∞–π –ø–æ–≤–µ—Å–µ–ª–∏–º—Å—è! –í–≤–µ–¥–∏ –∫–æ–º–∞–Ω–¥—É /fuck`);
      }

      // –†–µ–∞–∫—Ü–∏—è –Ω–∞ —Å–ª–æ–≤–æ "–∫–æ—Ñ–µ"
      else if (lowerText.includes('–∫–æ—Ñ–µ') || lowerText.includes('–∫–æ—Ñ–∏–π')) {
        await bot.sendMessage(chatId, '‚òïÔ∏è –ë—É—Å—Ç–∏–º! –ö–æ—Ñ–µ - –ª—É—á—à–∏–π –¥—Ä—É–≥ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–∞!');
      }

      // –†–µ–∞–∫—Ü–∏—è –Ω–∞ –ª—é–±–æ–µ –¥—Ä—É–≥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
      else {
        // –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π —Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä–æ–∫—É, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å, —á—Ç–æ–±—ã –±–æ—Ç —Ä–µ–∞–≥–∏—Ä–æ–≤–∞–ª –Ω–∞ –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        // await bot.sendMessage(chatId, `–ü—Ä–∏–≤–µ—Ç, ${userName}! –Ø —Ç–µ–±—è —É—Å–ª—ã—à–∞–ª üëÇ`);
      }
    }

    // –í—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–µ–º OK, —á—Ç–æ–±—ã Telegram –Ω–µ –ø—ã—Ç–∞–ª—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –ø–æ–≤—Ç–æ—Ä–Ω–æ
    res.status(200).send('OK');
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
    // –í—Å–µ —Ä–∞–≤–Ω–æ –æ—Ç–≤–µ—á–∞–µ–º OK, —á—Ç–æ–±—ã –Ω–µ –ø–æ–ª—É—á–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
    res.status(200).send('OK'); 
  }
});

// ===== –ó–ê–ü–£–°–ö –°–ï–†–í–ï–†–ê =====
app.listen(port, async () => {
  console.log(`[Server] Webhook-—Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É ${port}`);
  
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–µ–±—Ö—É–∫ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω –≤–Ω–µ—à–Ω–∏–π URL
  if (webhookUrl && webhookUrl.startsWith('http')) {
    await setupWebhook();
  } else {
    console.log('[Info] Webhook URL –Ω–µ —É–∫–∞–∑–∞–Ω. –†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏.');
  }
});

// ===== –ì–†–ê–¶–ò–û–ó–ù–û–ï –ó–ê–í–ï–†–®–ï–ù–ò–ï –†–ê–ë–û–¢–´ =====
// –í–∞–∂–Ω–æ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –Ω–∞ Render
process.on('SIGTERM', () => {
  console.log('–ü–æ–ª—É—á–µ–Ω SIGTERM. –ì—Ä–∞—Ü–∏–æ–∑–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã...');
  process.exit(0);
});

process.on('SIGINT', () => {
  console.log('–ü–æ–ª—É—á–µ–Ω SIGINT. –ì—Ä–∞—Ü–∏–æ–∑–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã...');
  process.exit(0);
});